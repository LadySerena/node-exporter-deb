/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */
plugins {
    id "nebula.ospackage" version "8.4.1"
    id "de.undercouch.download" version "4.1.1"
}

if(tag != "1-fake"){
    def extractRelease = { it.split("-")}
    def full_version = extractRelease(tag)
    package_version = full_version[0]
    package_release = full_version[1]
}

task downloadNodeExporter(type: Download){
    src "${node_exporter_url}/v${node_exporter_version}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz"
    dest buildDir
    overwrite false
}

task untarArchive(type: Copy){
    dependsOn downloadNodeExporter
    from tarTree("${buildDir}/node_exporter-${node_exporter_version}.linux-amd64.tar.gz")
    into buildDir
}

task buildNodeExporter(type: Deb) {
    dependsOn untarArchive
    packageName 'node-exporter'
    version package_version
    release package_release
    arch "amd64"
    preInstall file('scripts/preInstall.sh')
    postInstall file('scripts/postInstall.sh')
    arch "amd64"
    os LINUX
    from("${buildDir}/node_exporter-${node_exporter_version}.linux-amd64") {
        user = 'root'
        permissionGroup = 'root'
        fileMode = 0751
        include 'node_exporter'
        into '/usr/sbin'
    }
    from('etc/systemd/'){
        into '/etc/systemd/system/'
        user 'root'
        permissionGroup 'root'
        fileMode 0644
    }

}

build {
    dependsOn buildNodeExporter
}